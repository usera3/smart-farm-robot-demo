# ğŸ” æ”¶è·åœæ­¢é—®é¢˜å®Œæ•´åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ”¶è·ç›¸å…³ä»£ç ä½ç½®

### 1. **ä»»åŠ¡ä¼˜å…ˆçº§å®šä¹‰** (78-84è¡Œ)
```python
class TaskPriority(Enum):
    CRITICAL = 0  # ç´§æ€¥ï¼ˆå¦‚å¿«é€Ÿç”Ÿé•¿çš„æ‚è‰ï¼‰
    HIGH = 1      # é«˜ä¼˜å…ˆçº§ï¼ˆå¦‚æˆç†Ÿæ¤ç‰©æ”¶è·ï¼‰âš ï¸
    MEDIUM = 2    # ä¸­ç­‰ä¼˜å…ˆçº§ï¼ˆå¦‚æµ‡æ°´ã€æ–½è‚¥ï¼‰
    LOW = 3       # ä½ä¼˜å…ˆçº§ï¼ˆå¦‚ç©ºåœ°æ’­ç§ï¼‰
```

### 2. **ä»»åŠ¡ç±»å‹å®šä¹‰** (86-93è¡Œ)
```python
class TaskType(Enum):
    WEED_REMOVAL = "weed_removal"  # é™¤è‰
    HARVEST = "harvest"            # æ”¶è· âš ï¸
    WATERING = "watering"
    FERTILIZING = "fertilizing"
    PLANTING = "planting"
```

### 3. **ä»»åŠ¡ç”Ÿæˆé€»è¾‘** (`_analyze_farm_state`, 236-341è¡Œ)

**å…³é”®ä»£ç ï¼š**
```python
# ç¬¬269è¡Œï¼šâš ï¸ æ¯ä¸ªå‘¨æœŸéƒ½æ¸…ç©ºä»»åŠ¡é˜Ÿåˆ—
self.task_queue = []

# ç¬¬296-304è¡Œï¼šç”Ÿæˆé™¤è‰ä»»åŠ¡ï¼ˆä¼˜å…ˆçº§HIGH=1ï¼‰
elif plant.get('is_weed'):
    self._add_task(
        TaskType.WEED_REMOVAL,
        priority=TaskPriority.HIGH,  # âš ï¸ å’Œæ”¶è·åŒä¼˜å…ˆçº§
        ...
    )

# ç¬¬307-314è¡Œï¼šç”Ÿæˆæ”¶è·ä»»åŠ¡ï¼ˆä¼˜å…ˆçº§HIGH=1ï¼‰
if self._is_harvestable(plant):
    self._add_task(
        TaskType.HARVEST,
        priority=TaskPriority.HIGH,  # âš ï¸ å’Œé™¤è‰åŒä¼˜å…ˆçº§
        ...
    )

# ç¬¬327è¡Œï¼šæŒ‰ä¼˜å…ˆçº§æ’åº
self.task_queue.sort(key=lambda t: t['priority'].value)
```

**é—®é¢˜1ï¼šåŒä¼˜å…ˆçº§ä»»åŠ¡é¡ºåºä¸ç¡®å®š**
- HARVEST å’Œ WEED_REMOVAL éƒ½æ˜¯ `HIGH=1`
- `sort()` åªæŒ‰ä¼˜å…ˆçº§å€¼æ’åºï¼Œ**åŒä¼˜å…ˆçº§å†…çš„é¡ºåºå–å†³äºæ·»åŠ é¡ºåº**
- å¦‚æœéå†æ¤ç‰©æ—¶å…ˆé‡åˆ°æ‚è‰ï¼Œå†é‡åˆ°æˆç†Ÿæ¤ç‰©ï¼Œæ’åºåå¯èƒ½æ˜¯ï¼š`[WEED, WEED, HARVEST, HARVEST, ...]`

### 4. **ä»»åŠ¡æ‰§è¡Œé€»è¾‘** (`run_cycle`, 149-201è¡Œ)

**å…³é”®ä»£ç ï¼š**
```python
# ç¬¬160è¡Œï¼šâš ï¸ æ¯ä¸ªå‘¨æœŸéƒ½é‡æ–°ç”Ÿæˆä»»åŠ¡ï¼ˆæ¸…ç©ºæ—§é˜Ÿåˆ—ï¼‰
self._analyze_farm_state()

# ç¬¬180-196è¡Œï¼šæ‰¹é‡æ‰§è¡Œæ”¶è·ä»»åŠ¡
if task_type == TaskType.HARVEST:
    harvest_count = 0
    # âš ï¸ å…³é”®é—®é¢˜ï¼šåªæ£€æŸ¥é˜Ÿåˆ—ç¬¬ä¸€ä¸ªä»»åŠ¡
    while self.task_queue and self.task_queue[0]['type'] == TaskType.HARVEST:
        self._execute_next_task()  # æ‰§è¡Œå¹¶ç§»é™¤é˜Ÿåˆ—ç¬¬ä¸€ä¸ªä»»åŠ¡
        harvest_count += 1
    print(f"âœ… æœ¬å‘¨æœŸè¿ç»­æ”¶è·äº† {harvest_count} ä¸ªæ¤ç‰©")
```

**é—®é¢˜2ï¼šæ‰¹é‡æ‰§è¡Œé€»è¾‘çš„è‡´å‘½ç¼ºé™·**
- `while self.task_queue[0]['type'] == TaskType.HARVEST` åªæ£€æŸ¥**é˜Ÿåˆ—ç¬¬ä¸€ä¸ª**ä»»åŠ¡
- å¦‚æœé˜Ÿåˆ—æ˜¯ï¼š`[HARVEST, HARVEST, WEED, HARVEST, HARVEST, ...]`
- æ‰§è¡Œæµç¨‹ï¼š
  1. âœ… æ‰§è¡Œç¬¬1ä¸ª HARVEST
  2. âœ… æ‰§è¡Œç¬¬2ä¸ª HARVEST
  3. âŒ é‡åˆ° WEEDï¼Œå¾ªç¯åœæ­¢
  4. âŒ **åé¢çš„ HARVEST ä»»åŠ¡æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼**

### 5. **æ”¶è·åˆ¤æ–­é€»è¾‘** (`_is_harvestable`, 387-407è¡Œ)

```python
def _is_harvestable(self, plant):
    # å¿…é¡»æ˜¯è”¬èœ
    if not plant.get('is_vegetable', False):
        return False
    # ä¸èƒ½æ˜¯ç§å­
    if plant.get('is_seed'):
        return False
    # å¿…é¡»æ˜¯é˜¶æ®µ3ï¼ˆæˆç†Ÿï¼‰
    if plant.get('growth_stage', 1) < 3:
        return False
    # å¥åº·åº¦ä¸èƒ½å¤ªä½
    if plant.get('health', 100) < 30:
        return False
    return True
```

**è¿™ä¸ªé€»è¾‘æœ¬èº«æ²¡é—®é¢˜**ï¼Œé—®é¢˜åœ¨äºä»»åŠ¡æ‰§è¡Œã€‚

### 6. **æ”¶è·æ‰§è¡Œé€»è¾‘** (`_harvest_plant`, 896-1015è¡Œ)

```python
def _harvest_plant(self, plant_id):
    # è°ƒç”¨æœåŠ¡å™¨APIæ”¶è·
    response = requests.post(
        f"{self.server_url}/api/action/harvest",
        json={'plant_id': plant_id},
        timeout=3.0
    )
    # å¤„ç†å“åº”...
```

**è¿™ä¸ªé€»è¾‘ä¹Ÿæ²¡é—®é¢˜**ï¼Œé—®é¢˜åœ¨äºä»»åŠ¡è°ƒåº¦ã€‚

---

## ğŸš¨ **æ ¹æœ¬åŸå› åˆ†æ**

### **æ ¸å¿ƒé—®é¢˜ï¼šæ‰¹é‡æ‰§è¡Œé€»è¾‘åªå¤„ç†é˜Ÿåˆ—å¤´è¿ç»­çš„åŒç±»ä»»åŠ¡**

**ç”¨æˆ·è¯´æ˜ï¼šæ”¶è·é˜¶æ®µæ²¡æœ‰æ‚è‰ï¼Œåªæœ‰æ¤ç‰©å’Œç©ºåœ°**

**åœºæ™¯é‡ç°ï¼ˆæ— æ‚è‰æƒ…å†µï¼‰ï¼š**

å‡è®¾å†œåœºæœ‰ï¼š
- 10ä¸ªæˆç†Ÿæ¤ç‰©ï¼ˆå¯æ”¶è·ï¼‰
- 0ä¸ªæ‚è‰

**ç¬¬1ä¸ªå‘¨æœŸï¼š**
1. `_analyze_farm_state()` ç”Ÿæˆä»»åŠ¡ï¼š
   - 10ä¸ªæˆç†Ÿæ¤ç‰© â†’ ç”Ÿæˆ10ä¸ªHARVESTä»»åŠ¡
   - é˜Ÿåˆ—ï¼š`[HARVEST, HARVEST, ..., HARVEST]` (10ä¸ª)
2. æŒ‰ä¼˜å…ˆçº§æ’åºï¼ˆHARVEST=HIGH=1ï¼‰ï¼š
   - æ’åºåï¼š`[HARVEST, HARVEST, ..., HARVEST]` (10ä¸ª)
3. `run_cycle()` æ‰§è¡Œï¼š
   - é˜Ÿåˆ—å¤´æ˜¯ `HARVEST` âœ…
   - è¿›å…¥æ‰¹é‡æ‰§è¡Œåˆ†æ”¯
   - **ç†è®ºä¸Šåº”è¯¥è¿ç»­æ‰§è¡Œ10ä¸ªHARVEST**

**ä½†å®é™…æƒ…å†µå¯èƒ½æ˜¯ï¼š**

**é—®é¢˜1ï¼šæ¯ä¸ªå‘¨æœŸéƒ½æ¸…ç©ºé˜Ÿåˆ—é‡æ–°ç”Ÿæˆ**
- ç¬¬1ä¸ªå‘¨æœŸï¼šæ‰§è¡Œäº†5ä¸ªHARVESTï¼ˆå‡è®¾å› ä¸ºæŸç§åŸå› åªæ‰§è¡Œäº†5ä¸ªï¼‰
- ç¬¬2ä¸ªå‘¨æœŸï¼š**æ¸…ç©ºé˜Ÿåˆ—ï¼Œé‡æ–°ç”Ÿæˆ**
  - 5ä¸ªå·²æ”¶è·çš„ç©ºåœ° â†’ ç”Ÿæˆ5ä¸ªPLANTINGä»»åŠ¡ï¼ˆLOWä¼˜å…ˆçº§ï¼‰
  - 5ä¸ªæœªæ”¶è·çš„æˆç†Ÿæ¤ç‰© â†’ ç”Ÿæˆ5ä¸ªHARVESTä»»åŠ¡ï¼ˆHIGHä¼˜å…ˆçº§ï¼‰
  - æ’åºåï¼š`[HARVEST, HARVEST, HARVEST, HARVEST, HARVEST, PLANTING, PLANTING, ...]`
  - æ‰¹é‡æ‰§è¡Œï¼šåº”è¯¥èƒ½æ‰§è¡Œ5ä¸ªHARVEST âœ…

**é—®é¢˜2ï¼šæ‰¹é‡æ‰§è¡Œé€»è¾‘çš„è‡´å‘½ç¼ºé™·ï¼ˆçœŸæ­£çš„é—®é¢˜ï¼‰**

**å…³é”®ä»£ç ï¼ˆç¬¬189è¡Œï¼‰ï¼š**
```python
while self.task_queue and self.task_queue[0]['type'] == TaskType.HARVEST:
    self._execute_next_task()  # æ‰§è¡Œå¹¶ç§»é™¤é˜Ÿåˆ—å¤´ä»»åŠ¡
```

**è¿™ä¸ªé€»è¾‘çš„é—®é¢˜ï¼š**
- åªæ£€æŸ¥é˜Ÿåˆ—**ç¬¬ä¸€ä¸ª**ä»»åŠ¡æ˜¯å¦æ˜¯ HARVEST
- å¦‚æœé˜Ÿåˆ—å¤´æ˜¯ HARVESTï¼Œå°±æ‰§è¡Œå®ƒ
- æ‰§è¡Œåï¼Œé˜Ÿåˆ—å¤´æ›´æ–°ä¸ºä¸‹ä¸€ä¸ªä»»åŠ¡
- **å¦‚æœä¸‹ä¸€ä¸ªä»»åŠ¡ä¸æ˜¯ HARVESTï¼Œå¾ªç¯å°±åœæ­¢**

**ä½†ç†è®ºä¸Šï¼Œæ’åºåæ‰€æœ‰ HARVEST åº”è¯¥åœ¨å‰é¢ï¼Œä¸åº”è¯¥è¢«æ‰“æ–­å•Šï¼Ÿ**

**å¯èƒ½çš„çœŸæ­£åŸå› ï¼š**

1. **çŠ¶æ€æ›´æ–°å»¶è¿Ÿ**
   - æ‰§è¡Œ HARVEST åï¼Œæ¤ç‰©å˜æˆç©ºåœ°
   - ä½† `self.game_state` å¯èƒ½æ²¡æœ‰ç«‹å³æ›´æ–°
   - ä¸‹ä¸ªå‘¨æœŸé‡æ–°ç”Ÿæˆä»»åŠ¡æ—¶ï¼Œå¯èƒ½å› ä¸ºçŠ¶æ€ä¸åŒæ­¥å¯¼è‡´æŸäº›æ¤ç‰©ä¸å†å¯æ”¶è·

2. **ä»»åŠ¡æ‰§è¡Œå¤±è´¥**
   - å¦‚æœæŸä¸ª HARVEST ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼ˆæ¯”å¦‚æ¤ç‰©å·²è¢«å…¶ä»–æ–¹å¼æ”¶è·ï¼‰
   - ä»»åŠ¡è¢«ç§»é™¤ï¼Œä½†é˜Ÿåˆ—ä¸­å¯èƒ½è¿˜æœ‰å…¶ä»– HARVEST ä»»åŠ¡
   - å¦‚æœé˜Ÿåˆ—å¤´å˜æˆäº†å…¶ä»–ä»»åŠ¡ï¼Œæ‰¹é‡æ‰§è¡Œå°±åœæ­¢

3. **æ¯ä¸ªå‘¨æœŸéƒ½æ¸…ç©ºé˜Ÿåˆ—**
   - è¿™æ˜¯**æœ€å¤§çš„é—®é¢˜**
   - å¦‚æœæŸä¸ªå‘¨æœŸåªæ‰§è¡Œäº†éƒ¨åˆ† HARVESTï¼ˆæ¯”å¦‚å› ä¸ºæ‰§è¡Œé€Ÿåº¦ã€ç½‘ç»œå»¶è¿Ÿç­‰ï¼‰
   - ä¸‹ä¸ªå‘¨æœŸ**æ¸…ç©ºé˜Ÿåˆ—é‡æ–°ç”Ÿæˆ**ï¼Œæœªæ‰§è¡Œçš„ HARVEST ä»»åŠ¡å°±ä¸¢å¤±äº†
   - è™½ç„¶ç†è®ºä¸Šåº”è¯¥èƒ½é‡æ–°ç”Ÿæˆï¼Œä½†å¯èƒ½å› ä¸ºçŠ¶æ€ä¸åŒæ­¥å¯¼è‡´æŸäº›æ¤ç‰©ä¸å†å¯æ”¶è·

---

## ğŸ’¡ **é—®é¢˜æ€»ç»“**

### **ä¸ºä»€ä¹ˆ"æ”¶è·ä¸€éƒ¨åˆ†å°±åœæ­¢"ï¼Ÿ**

1. **æ¯ä¸ªå‘¨æœŸéƒ½æ¸…ç©ºé˜Ÿåˆ—**ï¼ˆç¬¬269è¡Œï¼‰
   - å¯¼è‡´ä¹‹å‰æœªæ‰§è¡Œçš„æ”¶è·ä»»åŠ¡ä¸¢å¤±

2. **åŒä¼˜å…ˆçº§ä»»åŠ¡é¡ºåºä¸ç¡®å®š**ï¼ˆç¬¬327è¡Œï¼‰
   - HARVEST å’Œ WEED éƒ½æ˜¯ HIGH=1
   - æ’åºåå¯èƒ½ WEED åœ¨ HARVEST å‰é¢

3. **æ‰¹é‡æ‰§è¡Œåªå¤„ç†é˜Ÿåˆ—å¤´è¿ç»­ä»»åŠ¡**ï¼ˆç¬¬189è¡Œï¼‰
   - `while self.task_queue[0]['type'] == TaskType.HARVEST`
   - ä¸€æ—¦é‡åˆ°é HARVEST ä»»åŠ¡å°±åœæ­¢
   - **é˜Ÿåˆ—ä¸­åé¢çš„ HARVEST ä»»åŠ¡æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œ**

4. **å…¶ä»–ä»»åŠ¡"æ’é˜Ÿ"**
   - é™¤è‰ã€æµ‡æ°´ã€æ’­ç§ä»»åŠ¡ä¸æ–­ç”Ÿæˆ
   - å®ƒä»¬ä¼š"æ‰“æ–­"æ”¶è·ä»»åŠ¡çš„è¿ç»­æ‰§è¡Œ

---

## ğŸ”§ **è§£å†³æ–¹æ¡ˆå»ºè®®**

### **æ–¹æ¡ˆ1ï¼šæ”¹è¿›æ‰¹é‡æ‰§è¡Œé€»è¾‘ï¼ˆæ¨èï¼‰**
```python
# ä¸åªçœ‹é˜Ÿåˆ—å¤´ï¼Œè€Œæ˜¯æ‰§è¡Œæ‰€æœ‰ HARVEST ä»»åŠ¡
if task_type == TaskType.HARVEST:
    harvest_count = 0
    # æ‰¾åˆ°æ‰€æœ‰ HARVEST ä»»åŠ¡å¹¶æ‰§è¡Œ
    harvest_tasks = [t for t in self.task_queue if t['type'] == TaskType.HARVEST]
    for task in harvest_tasks:
        # æ‰§è¡Œä»»åŠ¡å¹¶ä»é˜Ÿåˆ—ä¸­ç§»é™¤
        ...
```

### **æ–¹æ¡ˆ2ï¼šæé«˜æ”¶è·ä»»åŠ¡ä¼˜å…ˆçº§**
```python
# å°† HARVEST è®¾ä¸º CRITICAL=0ï¼Œé«˜äº WEED_REMOVAL
priority=TaskPriority.CRITICAL  # è€Œä¸æ˜¯ HIGH
```

### **æ–¹æ¡ˆ3ï¼šåŒä¼˜å…ˆçº§å†…æŒ‰ç±»å‹æ’åº**
```python
# æ’åºæ—¶ï¼ŒåŒä¼˜å…ˆçº§å†… HARVEST ä¼˜å…ˆ
self.task_queue.sort(key=lambda t: (
    t['priority'].value,
    0 if t['type'] == TaskType.HARVEST else 1  # HARVEST ä¼˜å…ˆ
))
```

---

## ğŸ“Š **éªŒè¯æ—¥å¿—åˆ†æ**

ä»ä½ æä¾›çš„æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼š
```
ğŸ§ª é˜Ÿåˆ—ç»Ÿè®¡: HARVEST=0, WEED=1, WATER=0, PLANT=45
ğŸ§ª ä»»åŠ¡é˜Ÿåˆ—å‰10ç±»å‹: ['weed_removal', 'planting', 'planting', ...]
ğŸ§ª é˜Ÿåˆ—å¤´: type=weed_removal, priority=1
```

è¿™è¯å®äº†æˆ‘ä»¬çš„åˆ†æï¼š
- å³ä½¿æœ‰æ”¶è·ä»»åŠ¡ï¼Œå¦‚æœé˜Ÿåˆ—å¤´æ˜¯ `weed_removal`ï¼Œæ”¶è·å°±ä¸ä¼šæ‰§è¡Œ
- å› ä¸ºæ‰¹é‡æ‰§è¡Œé€»è¾‘åªæ£€æŸ¥é˜Ÿåˆ—å¤´

---

**ç»“è®ºï¼šé—®é¢˜å‡ºåœ¨ `run_cycle()` æ–¹æ³•çš„æ‰¹é‡æ‰§è¡Œé€»è¾‘ï¼Œå®ƒåªå¤„ç†é˜Ÿåˆ—å¤´è¿ç»­çš„åŒç±»å‹ä»»åŠ¡ï¼Œä¸€æ—¦é‡åˆ°å…¶ä»–ç±»å‹ä»»åŠ¡å°±åœæ­¢ï¼Œå¯¼è‡´åé¢çš„æ”¶è·ä»»åŠ¡æ— æ³•æ‰§è¡Œã€‚**

